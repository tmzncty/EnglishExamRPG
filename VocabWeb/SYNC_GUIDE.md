# 跨设备数据同步说明

## 🎯 问题解决

之前的问题是：**浏览器的 LocalStorage 是每个设备独立的**，即使访问同一个服务器，手机和电脑的数据也不会共享。

## ✨ 解决方案

现在实现了**基于服务器端文件存储的跨设备同步**：

### 架构设计

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   电脑浏览器   │         │  Flask 服务器 │         │  手机浏览器   │
│             │         │             │         │             │
│ LocalStorage│ ←─────→ │ user_vocab.db│ ←─────→ │ LocalStorage│
│   (缓存)    │  同步    │   (主数据)   │  同步    │   (缓存)    │
└─────────────┘         └─────────────┘         └─────────────┘
```

### 工作流程

1. **初次加载**
   - 优先从服务器获取数据库
   - 如果服务器无数据，使用本地缓存或预构建数据库
   - 加载后自动保存到服务器

2. **学习过程**
   - 每次答题后立即更新数据库
   - 每 30 秒自动保存到服务器
   - 同时更新本地 LocalStorage 缓存

3. **跨设备访问**
   - 任何设备打开页面时，都从服务器获取最新数据
   - 所有设备共享 `user_vocab.db` 文件
   - 实现真正的数据同步

4. **离线支持**
   - 网络断开时使用 LocalStorage 缓存
   - 恢复网络后自动同步到服务器

## 🚀 使用方法

### Windows 快速启动

双击 `start.bat` 或在命令行执行：

```bash
cd F:\sanity_check_avg\VocabWeb
python server.py
```

### 多设备访问

1. **电脑访问**
   ```
   http://localhost:8080
   ```

2. **手机访问**（确保在同一 Wi-Fi）
   ```
   # 先查看电脑 IP 地址
   ipconfig  # Windows
   ifconfig  # Mac/Linux
   
   # 假设电脑 IP 是 192.168.1.100
   http://192.168.1.100:8080
   ```

## 📊 API 接口

### GET /api/status
查询服务器状态和数据库信息

### GET /api/get-db
获取用户数据库（Base64 编码）

### POST /api/save-db
保存用户数据库

```json
{
  "database": "base64_encoded_database"
}
```

## 🔧 技术细节

### 数据格式
- **传输**: Base64 编码的 SQLite 数据库
- **存储**: 服务器端保存为 `user_vocab.db` 文件
- **备份**: 每次保存前自动备份为 `user_vocab.db.backup`

### 自动保存机制
```javascript
// db.js 中的自动保存定时器
setInterval(() => {
    this.saveToServer();
}, 30000); // 30秒
```

### 同步优先级
1. 服务器数据（最高优先级）
2. LocalStorage 缓存
3. 预构建数据库（首次使用）

## 🎨 字体优化

现在使用 **霞鹜文楷等宽字体** (LXGWWenKaiMono)：
- 更好的中文显示效果
- 适合学习场景
- 优雅的字形设计

## ⚠️ 注意事项

1. **网络要求**
   - 手机和电脑需要在同一局域网
   - 确保防火墙允许 8080 端口

2. **数据安全**
   - 数据仅保存在本地服务器
   - 不会上传到互联网
   - 建议定期备份 `user_vocab.db`

3. **多用户**
   - 当前版本所有设备共享同一个数据库
   - 如需多用户支持，可修改为基于用户 ID 的数据库

## 🆚 对比

| 特性 | 旧方案 (LocalStorage) | 新方案 (服务器同步) |
|------|---------------------|-------------------|
| 跨设备同步 | ❌ | ✅ |
| 离线使用 | ✅ | ✅ |
| 数据丢失风险 | 高（清除缓存即丢失） | 低（服务器保存） |
| 多端一致性 | ❌ | ✅ |
| 实时同步 | ❌ | ✅ (30秒) |

## 🎉 享受学习吧！

现在你可以：
- 🏠 在家用电脑学习
- 📱 在路上用手机复习
- 💻 在图书馆用笔记本继续
- 🔄 所有进度实时同步！
