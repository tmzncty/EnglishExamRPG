# VocabWeb 新功能说明

## ✨ 新增功能

### 1. 📝 AI 讲解缓存
- **功能**: AI 生成的讲解会自动保存到数据库
- **优势**: 
  - 同一个词的讲解只需生成一次
  - 节省 API 调用成本
  - 加快响应速度
  - 离线也能查看已缓存的讲解

### 2. ⬅️ 上一题功能
- **位置**: 答题后的按钮区域
- **功能**: 可以返回查看之前做过的题目
- **用途**: 
  - 复习刚才学过的单词
  - 重新查看讲解
  - 对比不同单词的用法

### 3. 📋 智能错题本系统
- **错题标记**: 答错的单词自动进入错题本
- **三次消除**: 连续答对 3 次后自动移出错题本
- **进度追踪**: 显示每个错题的连续答对次数
- **统计显示**: 
  - 右侧统计面板显示错题数量
  - 完成页面显示待复习错题数

### 4. 🔀 错题智能混入
- **自动混入**: 错题会随机混入每日学习中
- **比例控制**: 错题最多占 20% 的学习量
- **优先级高**: 确保错题得到及时复习
- **打乱顺序**: 错题和新词随机排列，避免模式化

### 5. 📈 灵活的每日目标
- **最低目标**: 设置的数量是最低学习量
- **可以多学**: 完成目标后可以继续学习
- **不能少学**: 必须完成设定的最低目标
- **说明提示**: 设置界面有清晰的说明文字

## 🎯 使用场景

### 错题本工作流
```
第1次: 答错 → 进入错题本 (连续正确: 0/3)
第2次: 答对 → 仍在错题本 (连续正确: 1/3)
第3次: 答对 → 仍在错题本 (连续正确: 2/3)
第4次: 答对 → 移出错题本 ✅ (连续正确: 3/3)

注意: 中途答错会重置计数器
```

### 每日学习流程
```
1. 打开应用
2. 系统计算今日学习内容:
   - 设定目标: 20 个词
   - 错题数量: 5 个
   - 实际安排: 15 个常规词 + 5 个错题
3. 随机打乱顺序
4. 开始学习
5. 完成后可选择继续学习更多
```

## 💾 数据库结构更新

### learning_records 表新增字段
- `consecutive_correct`: 连续答对次数 (用于错题本)
- `is_mistake`: 是否为错题 (0=正常，1=错题)

## 🔧 技术实现

### AI 缓存机制
```javascript
// 先查缓存
let explanation = db.getExplanation(wordId, sentenceId);

if (!explanation) {
    // 调用 API 生成
    explanation = await aiService.generateExplanation(...);
    
    // 保存到数据库
    db.addExplanation(wordId, sentenceId, explanation);
}
```

### 错题更新逻辑
```javascript
if (isCorrect) {
    consecutiveCorrect++;
    if (isMistake && consecutiveCorrect >= 3) {
        // 移出错题本
        isMistake = 0;
        consecutiveCorrect = 0;
    }
} else {
    // 答错，重置并标记为错题
    consecutiveCorrect = 0;
    isMistake = 1;
}
```

### 错题混入算法
```javascript
// 1. 获取错题（最多占20%）
const mistakeCount = Math.min(
    Math.floor(dailyGoal * 0.2), 
    db.getMistakeCount()
);

// 2. 获取常规词汇
const normalWords = db.getTodayWords(dailyGoal - mistakeCount);

// 3. 合并并打乱
const allWords = [...normalWords, ...mistakeWords];
shuffleArray(allWords);
```

## 📊 统计信息

右侧面板显示:
- ✨ 今日学习: 新词数量
- 📚 今日复习: 复习词数量
- 🎯 累计学习: 总学习词数
- 📈 正确率: 当日正确率
- 📋 错题本: 待复习错题数量 (红色显示)

## 🎨 UI 改进

1. **按钮布局**: 上一题和下一题并排显示
2. **错题提示**: 错题数量用红色高亮
3. **设置说明**: 添加每日目标的详细说明
4. **完成提示**: 显示错题本状态

## 🚀 性能优化

1. **AI 缓存**: 减少重复 API 调用
2. **数据库索引**: 优化错题查询性能
3. **分块编码**: 避免大数据栈溢出
4. **预构建数据库**: 首次加载更快

## 📝 注意事项

1. **错题计数**: 只统计不同的单词，不重复计数
2. **缓存失效**: 如果 AI 讲解生成失败，不会缓存错误信息
3. **上一题限制**: 只能返回到第一题，不能无限后退
4. **目标调整**: 修改每日目标后，需要刷新页面重新加载
